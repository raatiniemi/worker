#!/bin/bash
# This script will configure the CI container environment, based on the java:8
# docker image, instead of keeping listing commands in the `.gitlab-ci.yml`.

if [ -z $ANDROID_HOME ]; then
  echo "No ANDROID_HOME have been defined.";
  exit 1;
fi

ANDROID_SDK_TOOLS="25.2.5";
ANDROID_BUILD_TOOLS="27.0.3";
ANDROID_COMPILE_SDK="27";

echo "Ensure system is up-to-date and install Android dependencies";
dpkg --add-architecture i386;
apt-get -qq update -y 1>/dev/null;
apt-get -qq install -y libstdc++6:i386 zlib1g:i386 libncurses5:i386 --no-install-recommends 1>/dev/null;

echo "Install Android SDK tools to ${ANDROID_HOME}";
mkdir -p "${ANDROID_HOME}";
curl -O -Ls "http://dl.google.com/android/repository/tools_r${ANDROID_SDK_TOOLS}-linux.zip";
unzip -qq "tools_r${ANDROID_SDK_TOOLS}-linux.zip" -d "${ANDROID_HOME}";

function accept_license_and_install {
  yes | "${ANDROID_HOME}/tools/bin/sdkmanager" $1 1>/dev/null;
  if [ $? -ne 0 ]; then
    echo "Failed to install and accept licenses for ${1}";
    exit 1;
  fi
}

echo "Installing Android SDK platforms and tools";
accept_license_and_install "platform-tools";
accept_license_and_install "build-tools;${ANDROID_BUILD_TOOLS}";
accept_license_and_install "platforms;android-${ANDROID_COMPILE_SDK}";
accept_license_and_install "extras;android;m2repository";
